{% extends "archiver/base.html" %}

{% block title %}Competitions{% endblock %}

{% block headend %}{% include "_abcjs-headend.html" %}{% endblock %}

{% block content %}
{% load humanize %}
{% load embed_video_tags %}
{% load markdown_deux_tags %}
{% for competition in competitions %}
<div class="section">
    <div class="section-meta">
        <h2>{{ competition.title }}</h2>
        <p class="meta">Tune selection: {% if competition.tune_voting_state == 'BEFORE' %}pending.{% elif competition.tune_voting_state == 'IN' %}open!{% else %}closed.{% endif %}<br>{{ competition.tune_vote_open|naturalday }}–{{ competition.tune_vote_close|naturalday }}</p>
        <p class="meta">Performance selection: {% if competition.recording_voting_state == 'BEFORE' %}pending.{% elif competition.recording_voting_state == 'IN' %}open!{% else %}closed.{% endif %}<br>{{ competition.recording_vote_open|naturalday }}–{{ competition.recording_vote_close|naturalday }}</p>
        <p class="meta">Added by <a href="{% url 'user' user_id=competition.author.id %}">{{ competition.author.get_full_name }}</a></p>
    </div>
    <div class="section-body">
        {{ competition.text|markdown }}
        {% if competition.tune_voting_state == 'BEFORE' %}
            <p>Voting to select the tune to learn and perform has not started yet. In the meantime, here are the tunes we'll be selecting from.</p>
            <ul>
            {% with tunes=competition.tune_set %}
                {% for tune in tunes %}
                <li>
                    <h3><a href="{% url 'tune' tune_id=tune.id %}">{{tune.title}}</a></h3>
                    <div id="staff-{{ id_prefix }}{{ forloop.counter }}"></div>
                    <div id="midi-{{ id_prefix }}{{ forloop.counter }}"></div>
                </li>
                {% empty %}
                <li>
                    <p>{{ empty_message|default:'No tunes' }}</p>
                </li>
                {% endfor %}
                <script type="text/javascript">
                window.addEventListener("load", function() {
                    const params = {
                        paddingleft:0,
                        paddingright:0,
                        responsive: "resize",
                    }
                    {% for tune in tunes %}
                    ABCJS.renderAbc("staff-{{ id_prefix }}{{ forloop.counter }}", "{{ tune.abc_preview|escapejs }}", params);
                    ABCJS.renderMidi("midi-{{ id_prefix }}{{ forloop.counter }}", "{{ tune.abc|escapejs }}", params);
                    {% endfor %}
                }, false);
                </script>
            {% endwith %}
            </ul>
        {% elif competition.tune_voting_state == 'IN' %}
            <p>Voting is open to select the tune. The idea is once selected there'll then be time for people to learn this tune and share performances of it.</p>
        {% else %}
            {% with tune_won=competition.tune_won %}
            <p>The tune chosen by the community to learn is <a href="{% url 'tune' tune_id=tune_won.id %}">{{ tune_won.title }}</a>, staff notation shown below. The other tunes were {% for tune in competition.tune_set %}{% if tune != tune_won %}<a href="{% url 'tune' tune_id=tune.id %}">{{ tune.title }}</a>{% if not forloop.last %}, {% endif %}{% endif %}{% endfor %}.</p>
            <textarea class="abc" id="abc-tune-won" readonly hidden>{{ tune_won.abc }}</textarea>
            <div id="staff-tune-won"></div>
            <div id="midi-tune-won"></div>
            <script>
            window.addEventListener("load", function() {
                const el = document.getElementById("abc-tune-won");
                el.setAttribute("rows", el.innerHTML.split(/\n/).length)
                // abcjs
                const colorRange = function(range, color) {
                    if (range && range.elements) {
                        range.elements.forEach(function (set) {
                            set.forEach(function (item) {
                                item.setAttribute("fill", color);
                            });
                        });
                    }
                };
                const animateCallback = function(lastRange, currentRange, context) {
                    colorRange(lastRange, "#000000");
                    colorRange(currentRange, "#3D9AFC");
                };
                new ABCJS.Editor("abc-tune-won", { 
                    canvas_id: "staff-tune-won",
                    generate_midi: true,
                    midi_id:"midi-tune-won",
                    abcjsParams: {
                        generateInline: true,
                        generateDownload: false,
                        paddingleft:0,
                        paddingright:0,
                        responsive: "resize",
                        animate: {
                            listener: animateCallback, 
                            target: "staff-tune-won"
                        },
                    }
                });
            }, false);
            </script>
            {% endwith %}
        {% endif %}
        {% if competition.recording_voting_state == 'AFTER' %}
            <p>The winning performance was...TODO</p>
        {% endif %}
    </div>
</div>

{% if competition.tune_voting_state == 'IN' %}
{% with tunes=competition.tune_set %}
{% for tune in tunes %}
<div class="section">
    <div class="section-meta">
        <p class="meta">Vote!</p>
    </div>
    <div class="section-body">
        <h3><a href="{% url 'tune' tune_id=tune.id %}">{{tune.title}}</a></h3>
        <div id="staff-{{ id_prefix }}{{ forloop.counter }}"></div>
        <div id="midi-{{ id_prefix }}{{ forloop.counter }}"></div>
    </div>
</div>
{% endfor %}
<script type="text/javascript">
window.addEventListener("load", function() {
    const params = {
        paddingleft:0,
        paddingright:0,
        responsive: "resize",
    }
    {% for tune in tunes %}
    ABCJS.renderAbc("staff-{{ id_prefix }}{{ forloop.counter }}", "{{ tune.abc_preview|escapejs }}", params);
    ABCJS.renderMidi("midi-{{ id_prefix }}{{ forloop.counter }}", "{{ tune.abc|escapejs }}", params);
    {% endfor %}
}, false);
</script>
{% endwith %}
{% endif %}

{% if competition.recording_voting_state == 'IN' %}
{% for recording in competition.recording_set %}
<div class="section">
    <div class="section-meta">
        <p class="meta">Vote!</p>
    </div>
    <div class="section-body">
        {% video recording.video is_secure=True as my_video %}
          {% video my_video%}
        {% endvideo %}
    </div>
</div>
{% endfor %}
{% endif %}


<div class="section">
    <div class="section-meta">
        <h3>Discuss</h3>
    </div>
    <div class="section-body">
        <ul>
            {% for comment in competition.comment_set.all %}
            <li>
                <p>{{ comment.text}}</p>
                <p class="meta">Posted by <a href="{% url 'user' user_id=comment.author.id %}">{{ comment.author.get_full_name }}</a> {{ comment.submitted|naturalday }}.</li>
            </li>
            {% empty %}
            <li>
                <p>No comments yet.</p>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

{% endfor %}
{% endblock %}
